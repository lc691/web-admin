{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Edit Show</h2>

    <!-- ================= EDIT SHOW FORM ================= -->
    <form action="/shows/edit/{{ show.id }}" method="post">
        {# CSRF token (aktifkan jika backend mendukung) #}
        {# <input type="hidden" name="csrf_token" value="{{ csrf_token }}"> #}

        <div class="mb-3">
            <label class="form-label">Judul</label>
            <input type="text" name="title" class="form-control" value="{{ show.title }}" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Sinopsis</label>
            <textarea name="sinopsis" class="form-control" rows="4">{{ show.sinopsis }}</textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">Genre</label>
            <select name="genre" class="form-select" required>
                {% set genre_options = [
                "üá®üá≥ Drama China",
                "üá∫üá∏ Drama Barat",
                "üá∞üá∑ Drama Korea",
                "üáØüáµ Drama Jepang",
                "üáπüá≠ Drama Thailand"
                ] %}
                {% for g in genre_options %}
                <option value="{{ g }}" {{ "selected" if show.genre==g else "" }}>
                    {{ g }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">Source</label>
            <select name="source" class="form-select" required>
                {% set source_options = [
                "Dramabox","FlickReels","NetShort","Dramawave","Melolo",
                "Stardust","Iqiyi","GoodShort","BiliTV","ReelShort",
                "Moboreels","RapidTV","Shortmax","Dotdrama"
                ] %}
                {% for src in source_options %}
                <option value="{{ src }}" {{ "selected" if show.source==src else "" }}>
                    {{ src }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">Hashtags</label>
            <input type="text" name="hashtags" class="form-control" value="{{ show.hashtags }}"
                placeholder="#romance #drama">
        </div>

        <div class="mb-3">
            <label class="form-label">Thumbnail URL</label>
            <input type="url" name="thumbnail_url" class="form-control" value="{{ show.thumbnail_url or '' }}"
                placeholder="Kosongkan untuk menghapus thumbnail">
        </div>

        <div class="mb-3">
            <label class="form-label">Preview Thumbnail</label><br>
            {% if show.resolved_thumbnail %}
            <img src="{{ show.resolved_thumbnail }}" alt="Thumbnail Preview" class="img-thumbnail"
                style="max-width:200px;">
            {% else %}
            <img src="/static/img/placeholder.png" class="img-thumbnail opacity-50" style="max-width:200px;"
                alt="Tidak ada thumbnail">
            <div class="text-muted small mt-1">Tidak ada thumbnail</div>
            {% endif %}
        </div>

        <div class="mb-3">
            <label class="form-label">Konten Dewasa?</label>
            <select name="is_adult" class="form-select">
                <option value="0" {{ "selected" if not show.is_adult else "" }}>Tidak</option>
                <option value="1" {{ "selected" if show.is_adult else "" }}>Ya</option>
            </select>
        </div>

        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">
                Simpan
            </button>
            <a href="/shows" class="btn btn-secondary">
                Batal
            </a>
        </div>
    </form>

    <!-- ================= IMPORT FILES SECTION ================= -->
    <hr class="my-5">

    <div class="card shadow-sm border-start border-info border-3">
        <div class="card-body">
            <h5 class="card-title text-info mb-2">
                üîÅ Import Files dari Show Lain
            </h5>
            <p class="text-muted">
                Menyalin semua file dari show lain ke show ini.
            </p>

            {% if shows|length <= 1 %} <div class="alert alert-warning mb-0">
                Tidak ada show lain yang bisa diimport.
        </div>
        {% else %}

        {% if request.query_params.get("error") %}
        <div class="alert alert-danger">
            {{ request.query_params.get("error") }}
        </div>
        {% endif %}

        <form method="post" action="/shows/{{ show.id }}/import-files"
            onsubmit="return confirm('Yakin ingin mengimport semua file dari show ini?')">
            <div class="mb-3">
                <label class="form-label">Source Show</label>
                <select name="source_show_id" class="form-select select-show" required>
                    {% for s in shows %}
                    {% if s.id != show.id %}
                    <option value="{{ s.id }}" data-thumbnail="{{ s.thumbnail_url or '/static/img/placeholder.png' }}">
                        {{ s.id }} ‚Äî {{ s.title }}
                    </option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">Message ID</label>
                <input type="text" id="message_id_input" name="message_id" class="form-control"
                    placeholder="4669 atau https://t.me/channel/4669" required>
            </div>

            <button type="submit" class="btn btn-info">
                <i class="fas fa-copy"></i> Import Files
            </button>
        </form>

        {% if request.query_params.get("imported") %}
        <div class="alert alert-success mt-3">
            ‚úÖ {{ request.query_params.get("imported") }} file berhasil diimport
        </div>
        {% endif %}

        {% endif %}
    </div>
</div>
</div>
{% endblock %}

{% block scripts %}
<script>
    (function () {
        const input = document.getElementById('message_id_input');
        if (!input) return;

        input.addEventListener('input', function () {
            const val = this.value.trim();
            const match = val.match(/\/(\d+)(?:\D|$)/);

            if (match) {
                this.value = match[1];
                return;
            }

            const nums = val.match(/\d+/g);
            if (nums) {
                this.value = nums[nums.length - 1];
            }
        });
    })();
</script>

<script>
    function formatShowDropdown(option) {
        if (!option.id) return option.text;

        const thumb = $(option.element).data('thumbnail');

        return $(`
        <div class="d-flex align-items-center gap-3">
            <img
                src="${thumb}"
                style="width:96px;height:54px;object-fit:cover;border-radius:6px;border:1px solid #ddd;"
                onerror="this.src='/static/img/placeholder.png'"
            >
            <div class="fw-semibold">${option.text}</div>
        </div>
    `);
    }

    $(document).ready(function () {
        $('.select-show').select2({
            width: '100%',
            placeholder: 'Cari show berdasarkan ID atau judul...',
            templateResult: formatShowDropdown,
            templateSelection: option => option.text
        });
    });
</script>
{% endblock %}