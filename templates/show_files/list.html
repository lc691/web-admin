{% extends "base.html" %}

{% block content %}
<h1 class="h3 mb-3">Daftar File per Show</h1>

{% if request.query_params.get("updated") %}
<div class="alert alert-success alert-dismissible fade show">
    {{ request.query_params.get("updated") }} data berhasil diperbarui.
    <button type="button" class="close" data-dismiss="alert">&times;</button>
</div>
{% endif %}

<div class="d-flex align-items-center mb-3">

    <!-- BULK DELETE -->
    <form id="bulkDeleteForm" method="post" action="/show_files/bulk-delete" class="mr-2">
        <input type="hidden" name="ids" id="bulkDeleteIds">
        <button id="bulkDeleteBtn" type="button" class="btn btn-danger btn-sm" disabled>
            üóë Hapus Terpilih
        </button>
    </form>

    <!-- BULK EDIT -->
    <form id="bulkEditForm" method="get" action="/show_files/bulk-edit" class="mr-3">
        <input type="hidden" name="ids" id="bulkEditIds">
        <button id="bulkEditBtn" type="button" class="btn btn-warning btn-sm" disabled>
            ‚úè Edit Terpilih
        </button>
    </form>

</div>

<div class="card shadow">
    <div class="card-body">
        <div class="table-responsive">
            <table id="showfilesTable" class="table table-bordered table-hover">
                <thead class="thead-light">
                    <tr>
                        <th>
                            <input type="checkbox" id="checkAll">
                        </th>
                        <th>ID</th>
                        <th>Show</th>
                        <th>File Name</th>
                        <th>Show_id</th>
                        <th>Message ID</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in rows %}
                    <tr>
                        <td class="text-center">
                            <input type="checkbox" class="row-check" value="{{ r.show_file_id }}"
                                data-show-count="{{ r.show_count }}">
                        </td>
                        <td>{{ r.show_file_id }}</td>
                        <td>{{ r.show_title }}</td>
                        <td class="text-break">{{ r.file_name }}</td>
                        <td>{{ r.show_id or "-" }}</td>
                        <td>{{ r.message_id or "-" }}</td>
                        <td class="text-nowrap">
                            <a href="/show_files/edit/{{ r.show_file_id }}" class="btn btn-warning btn-circle btn-sm"
                                title="Edit">
                                <i class="fas fa-pencil-alt"></i>
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            Tidak ada data
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    $(document).ready(function () {

        const table = $('#showfilesTable').DataTable({
            stateSave: true,
            order: [[1, 'desc']]
        });

        // =====================
        // CHECKBOX HANDLING
        // =====================
        function toggleBulkButtons() {
            const checked = $('.row-check:checked').length;
            $('#bulkDeleteBtn').prop('disabled', checked === 0);
            $('#bulkEditBtn').prop('disabled', checked === 0);
        }

        $('#checkAll').on('change', function () {
            $('.row-check').prop('checked', this.checked);
            toggleBulkButtons();
        });

        $(document).on('change', '.row-check', function () {
            $('#checkAll').prop(
                'checked',
                $('.row-check').length === $('.row-check:checked').length
            );
            toggleBulkButtons();
        });

        // =====================
        // BULK EDIT
        // =====================
        $('#bulkEditBtn').on('click', function () {
            const ids = $('.row-check:checked')
                .map(function () {
                    return parseInt(this.value, 10);
                })
                .get()
                .filter(Number.isInteger);

            $('#bulkEditIds').val(ids.join(','));
            $('#bulkEditForm').submit();
        });

        // =====================
        // BULK DELETE
        // =====================
        $('#bulkDeleteBtn').on('click', function () {
            const checked = $('.row-check:checked');

            if (!checked.length) return;

            let totalShows = 0;
            let ids = [];

            checked.each(function () {
                ids.push(this.value);
                totalShows += parseInt($(this).data('show-count'), 10);
            });

            let msg = 'Yakin ingin menghapus file yang dipilih?';

            if (totalShows > 0) {
                msg =
                    `‚ö†Ô∏è ${checked.length} file dipakai oleh ${totalShows} show.\n\n` +
                    `Menghapus file ini akan menghapusnya dari SEMUA show.\n\n` +
                    `Yakin ingin melanjutkan?`;
            }

            if (!confirm(msg)) return;

            $('#bulkDeleteIds').val(ids.join(','));
            $('#bulkDeleteForm').submit();
        });

        // =====================
        // TOOLTIP
        // =====================
        $('[data-toggle="tooltip"]').tooltip();

    });
</script>
{% endblock %}